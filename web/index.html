<!doctype html>
<html>
	<head>
  	<meta charset="utf-8">
  	<title>SpaceWebBattle</title>

  	<link rel="stylesheet" href="css/Main.css">

  	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.1.1/socket.io.js"></script>
	</head>
	<body>
  	<script>
      var socket = io.connect('http://127.0.0.1:8090/'); // соеденение с сервером
      socket.on('connect', function() { console.log("Connect - OK!"); socket.emit('NewPlayer', [0, 0, 0, 0, 0, 0]); });

			let PhysicsFPS = 5;
			let SpaceShipSprite;
			let GameOver;
			let Life = true;
			let SpeedLaser = 8;
			let GunReady = true;

			function sleep(milliseconds) {
			  const date = Date.now();
			  let currentDate = null;
			  do {
			    currentDate = Date.now();
			  } while (currentDate - date < milliseconds);
			}
			function random(min, max) { return Math.random() * (max - min) + min; }


      socket.on('ChangeAsteroid', function(data) { 
        console.log("OK", data);
        if(data.length == 2 && data[1] == "DESTROY") {
          console.log("DESTROY Asteroid");
          app.stage.removeChild(Asteroids[data[0]].Sprite);
          Asteroids[data[0]] = null;
        } else {
          if(Asteroids[data[0]] == null) {
            console.log("CREATE Asteroid");

            SpriteAsteroidNumber = parseInt(random(1, 4));
            Sprite = new PIXI.Sprite(PIXI.loader.resources[`sprites/asteroid_${SpriteAsteroidNumber}.png`].texture);
            Asteroids[data[0]] = new SpaceObject(Sprite, 0, 0, data[1], data[2], data[3], data[4], 0.5, data[5], data[6], 0.1);
            Asteroids[data[0]].Sprite.anchor.set(0.5, 0.5);
            Asteroids[data[0]].Sprite.position.set(Asteroids[data[0]].X, Asteroids[data[0]].Y);
            Asteroids[data[0]].Sprite.scale.set(data[7], data[7]);
            app.stage.addChild(Asteroids[data[0]].Sprite);
          } else {
            console.log("CHANGE Asteroid");

            Asteroids[data[0]].X = data[1];
            Asteroids[data[0]].Y = data[2];
            Asteroids[data[0]].SpeedX = data[3];
            Asteroids[data[0]].SpeedY = data[4];
            Asteroids[data[0]].Angle = data[5];
            Asteroids[data[0]].ChangeAnrgleSpeed = data[6];
          }
        }
      });
			function InitAsteroid(i, scale, manual=0, x=-1, y=-1, speedx=0, speedy=0, angle=0, speedangle=0) { 
				SpriteAsteroidNumber = parseInt(random(1, 4));
  			PathToSprite = `sprites/asteroid_${SpriteAsteroidNumber}.png`;
  			Sprite = new PIXI.Sprite(PIXI.loader.resources[PathToSprite].texture);
				if(manual == 0) {
					while(1) { 
						x_gen = random(-10, 1280+10)/1; 
						y_gen = random(-10, 720+10)/1;
						if(x_gen<0 || x_gen>1280 || y_gen<0 || y_gen>720) {break;} 
					}
					Asteroids[i] = new SpaceObject(Sprite, 0, 0, parseInt(x_gen), parseInt(y_gen), Math.random()/2, Math.random()/2, 0.5, random(0, 360), Math.random()/15, 0.1);
				} else {
					Asteroids[i] = new SpaceObject(Sprite, 0, 0, x, y, speedx, speedy, 0.5, angle, speedangle, 0.2);
				}
				Asteroids[i].Sprite.anchor.set(0.5, 0.5);
  			Asteroids[i].Sprite.position.set(Asteroids[i].X, Asteroids[i].Y);
  			Asteroids[i].Sprite.scale.set(scale, scale);

  			app.stage.addChild(Asteroids[i].Sprite);
			}

			function GenerageAsteroidsWreckage(x, y, scale) {
				for (var q = 0; q < parseInt(random(2, 5)); q++) {
  				Asteroids.push(null);
  				if(q%2) { new_speedx = random(-0.5, 0.5); new_speedy = random(-0.5, 0.5); 
  				} else { new_speedx = random(-0.5, 0.5); new_speedy = random(-0.5, 0.5); }
  				InitAsteroid(Asteroids.length-1, random(scale*0.5, scale*0.8), 1,
  											x+random(-20, 20), y+random(-20, 20), new_speedx, new_speedy, random(0, 360), Math.random()/15);
  			}
			} 

      socket.on('BOOM', function(data) { console.log("BOOM", data); AddBOOM(data[0], data[1]); });
			function AddBOOM(x, y) {
        let BOOMFrames = ["sprites/boom/0.gif", "sprites/boom/1.gif", "sprites/boom/2.gif", "sprites/boom/3.gif", "sprites/boom/4.gif", "sprites/boom/5.gif"];
        let BOOMTexture = [];
        for (let i=0; i < 6; i++) { BOOMTexture.push(PIXI.Texture.from(BOOMFrames[i])); }
				let BOOM = new PIXI.AnimatedSprite(BOOMTexture);
  			BOOM.scale.set(0.25, 0.25);
				BOOM.loop = false;
				BOOM.animationSpeed = 0.15;
				BOOM.anchor.set(0.5, 0.5);
  			BOOM.position.set(x, y);
  			app.stage.addChild(BOOM);
  			BOOM.onLoop = function () { app.stage.removeChild(BOOM); };
        BOOM.play();
			} 

			function Dead() {
				setTimeout(()=>{app.stage.addChild(GameOver);}, 1000);
  			setTimeout(()=>{location.reload();}, 5000);
  			AddBOOM(SpaceShip.X, SpaceShip.Y).play();
  			app.stage.removeChild(SpaceShip.Sprite);
  			Life = false;
			}

			function GetSpeedsForAngle(Angle, Engine) {
				if(Angle < 90) {
        	SpeedX = Math.sin(Angle *Math.PI/180) * Engine;
        	SpeedY = -1*Math.cos(Angle *Math.PI/180) * Engine;
        }
				else if(Angle < 180) {
        	SpeedX = Math.cos((Angle-90) *Math.PI/180) * Engine;
        	SpeedY = Math.sin((Angle-90) *Math.PI/180) * Engine;
        }
        else if(Angle < 270) {
        	SpeedX = -1*Math.sin((Angle-180) *Math.PI/180) * Engine;
        	SpeedY = Math.cos((Angle-180) *Math.PI/180) * Engine;
        }
        else {
        	SpeedX = -1*Math.cos((Angle-270) *Math.PI/180) * Engine;
        	SpeedY = -1*Math.sin((Angle-270) *Math.PI/180) * Engine;
        }
        return [SpeedX, SpeedY];
			}

			class SpaceObject {
			  constructor(Sprite, PowerForwardEngine, PowerTurnEngine, X, Y, SpeedX, SpeedY, MaxSpeed, Angle, ChangeAnrgleSpeed, MaxChangeAnrgleSpeed) { 
			    this.Sprite = Sprite;
			    this.PowerForwardEngine = PowerForwardEngine;
			    this.PowerTurnEngine = PowerTurnEngine;
			  	this.X = X; this.Y = Y;
			  	this.SpeedX = SpeedX; this.SpeedY = SpeedY;
			    this.MaxSpeed = MaxSpeed;
			  	this.Angle = Angle;
			  	this.ChangeAnrgleSpeed = ChangeAnrgleSpeed;
			    this.MaxChangeAnrgleSpeed = MaxChangeAnrgleSpeed;
			  }
			}

			let SpaceShip = new SpaceObject(null, 0.1, 0.5, 640, 360, 0, 0, 1.5, random(0, 360), random(0, 0.05), 3);
			let Asteroids = new Array();
			let Lasers = new Array();

			document.addEventListener('keydown', (event) => {
			  if(event.key === 'd' || event.key === 'ArrowRight') { 
			  	SpaceShip.ChangeAnrgleSpeed = SpaceShip.ChangeAnrgleSpeed + SpaceShip.PowerTurnEngine; 
			  	if(SpaceShip.ChangeAnrgleSpeed > SpaceShip.MaxChangeAnrgleSpeed) { SpaceShip.ChangeAnrgleSpeed = SpaceShip.MaxChangeAnrgleSpeed; }
			  }
			  if(event.key === 'a' || event.key === 'ArrowLeft') { 
			  	SpaceShip.ChangeAnrgleSpeed = SpaceShip.ChangeAnrgleSpeed - SpaceShip.PowerTurnEngine; 
			  	if(SpaceShip.ChangeAnrgleSpeed < -1*SpaceShip.MaxChangeAnrgleSpeed) { SpaceShip.ChangeAnrgleSpeed = -1*SpaceShip.MaxChangeAnrgleSpeed; }
			  }

			  if((event.key === ' ' || event.key === 'Spacebar') && GunReady) { 
			  	GunReady = false;
	  			setTimeout(()=>{GunReady = true;}, 1000);
			  	Angle = (SpaceShip.Angle+36000000)%360;
			  	let laser = new SpaceObject(null, 0, 0, SpaceShip.X, SpaceShip.Y, 0, 0, SpeedLaser, (SpaceShip.Angle+6000000)%6, 0, 0);
			  	laser.Sprite = new PIXI.Sprite(PIXI.loader.resources["sprites/laser.png"].texture);
          let Speeds = GetSpeedsForAngle(Angle, SpeedLaser);
			  	laser.SpeedX = Speeds[0];
			  	laser.SpeedY = Speeds[1];
			  	laser.Sprite.anchor.set(0.5, 0.5);
			  	console.log(Angle, SpaceShip.Angle);
  				laser.Sprite.scale.set(0.25, 0.25);
			  	app.stage.addChild(laser.Sprite);
			  	Lasers.push(laser);
			  }

			  if(event.key === 'w' || event.key === 'ArrowUp') { 
			  	Angle = (SpaceShip.Angle+36000000)%360;
          
          let Speeds = GetSpeedsForAngle(Angle, SpaceShip.PowerForwardEngine);
          console.log(Speeds);
          SpaceShip.SpeedX += Speeds[0];
          SpaceShip.SpeedY += Speeds[1];

          if(SpaceShip.SpeedX > SpaceShip.MaxSpeed) { SpaceShip.SpeedX = SpaceShip.MaxSpeed; }
        	if(SpaceShip.SpeedX < -1*SpaceShip.MaxSpeed) { SpaceShip.SpeedX = -1*SpaceShip.MaxSpeed; }
        	if(SpaceShip.SpeedY > SpaceShip.MaxSpeed) { SpaceShip.SpeedY = SpaceShip.MaxSpeed; }
        	if(SpaceShip.SpeedY < -1*SpaceShip.MaxSpeed) { SpaceShip.SpeedY = -1*SpaceShip.MaxSpeed; }
			  }
        
			}, false);

			let app = new PIXI.Application({ 
    		width: 1280, 
    		height: 720,                       
    		antialiasing: true, 
    		transparent: false, 
    		resolution: 1
  		});

			document.body.appendChild(app.view);
			let MainCanvas = new PIXI.Container();
			app.render(MainCanvas);

			app.view.style.position = "absolute";
			app.view.style.width = window.innerWidth + "px";
			app.view.style.height = window.innerHeight + "px";

			PIXI.loader
  					.add("sprites/spaceship.png")
  					.add("sprites/GameOver.png")
  					.add("sprites/laser.png")
  					.add("sprites/asteroid_1.png")
  					.add("sprites/asteroid_2.png")
  					.add("sprites/asteroid_3.png")
  					.add("sprites/asteroid_4.png")
  					.load(InitSpaceShip);

			function InitSpaceShip(progress,resources) {
  			SpaceShip.Sprite = new PIXI.Sprite(PIXI.loader.resources["sprites/spaceship.png"].texture);

  			SpaceShip.Sprite.anchor.set(0.5, 0.5);
  			SpaceShip.Sprite.position.set(512, 512);
  			SpaceShip.Sprite.scale.set(1.5, 1);
  			app.stage.addChild(SpaceShip.Sprite);

  			for (var i = 0; i < 100; i++) { Asteroids.push(null); }

				

				GameOver = new PIXI.Sprite(PIXI.loader.resources["sprites/GameOver.png"].texture);
			  GameOver.anchor.set(0.5, 0.5);
  			GameOver.position.set(640, 360);
  			GameOver.scale.set(1, 1);

  			app.ticker.add(delta => WhileTrue(delta));
			}

			function WhileTrue() {
  			SpaceShip.X += SpaceShip.SpeedX;
  			SpaceShip.Y += SpaceShip.SpeedY;
  			SpaceShip.Angle += SpaceShip.ChangeAnrgleSpeed;

  			SpaceShip.Sprite.x = SpaceShip.X;
  			SpaceShip.Sprite.y = SpaceShip.Y;
  			SpaceShip.Sprite.angle = SpaceShip.Angle; 

  			//if(SpaceShip.X > 1280 || SpaceShip.X < 0 ||
  			//	 SpaceShip.Y > 720 || SpaceShip.Y < 0) {
  			//	if(Life) { Dead(); Life = false; }         ~ ( Событие должно приходить с сервера ) ~
  			//}

  			for (var i = 0; i < Lasers.length; i++) {
  				Lasers[i].X += Lasers[i].SpeedX;
  				Lasers[i].Y += Lasers[i].SpeedY;
  				Lasers[i].Sprite.x = Lasers[i].X;
  				Lasers[i].Sprite.y = Lasers[i].Y;
  				Lasers[i].Sprite.angle = Lasers[i].Angle; 
  			}

  			boom = false;

  			for (var i = 0; i < Asteroids.length; i++) {
          if(Asteroids[i] == null) { continue; }

  				//if(Math.abs(Asteroids[i].X - SpaceShip.X) < 20 && Math.abs(Asteroids[i].Y - SpaceShip.Y) < 20) {
  				//	if(Life) {
  				//		Dead();
  				//		app.stage.removeChild(Asteroids[i].Sprite);  ~ ( Событие должно приходить с сервера ) ~
  				//		Life = false;
  				//	}
  				//}

  				Asteroids[i].X += Asteroids[i].SpeedX;
  				Asteroids[i].Y += Asteroids[i].SpeedY;
  				Asteroids[i].Angle += Asteroids[i].ChangeAnrgleSpeed;
  				//Asteroids[i].Angle = Asteroids[i].Angle%36;

  				Asteroids[i].Sprite.x = Asteroids[i].X;
  				Asteroids[i].Sprite.y = Asteroids[i].Y;
  				Asteroids[i].Sprite.angle = Asteroids[i].Angle; 
				}

  			sleep(60/PhysicsFPS);
			}
		</script>
  
	</body>
</html>