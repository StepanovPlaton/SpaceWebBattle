<!doctype html>
<html>
	<head>
  	<meta charset="utf-8">
  	<title>SpaceWebBattle</title>

  	<link rel="stylesheet" href="css/Main.css">

  	<script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.1.3/pixi.min.js"></script>
	</head>
	<body>
  	<script>
			let PhysicsFPS = 5; 
			let SpaceShipSprite;
			let BOOMTexture;
			let GameOver;
			let Life = true;
			let SpeedLaser = 5;
			let GunReady = true;

			function sleep(milliseconds) {
			  const date = Date.now();
			  let currentDate = null;
			  do {
			    currentDate = Date.now();
			  } while (currentDate - date < milliseconds);
			}
			function random(min, max) { return Math.random() * (max - min) + min; }

			function InitAsteroid(i, scale, manual=0, x=-1, y=-1, speedx=0, speedy=0, angle=0, speedangle=0) { 
				SpriteAsteroidNumber = parseInt(random(1, 4));
  			PathToSprite = `sprites/asteroid_${SpriteAsteroidNumber}.png`;
  			Sprite = new PIXI.Sprite(PIXI.loader.resources[PathToSprite].texture);
				if(manual == 0) {
					while(1) { 
						x_gen = random(-10, 1280+10)/1; 
						y_gen = random(-10, 720+10)/1;
						if(x_gen<0 || x_gen>1280 || y_gen<0 || y_gen>720) {break;} 
					}
					Asteroids[i] = new SpaceObject(Sprite, 0, 0, parseInt(x_gen), parseInt(y_gen), Math.random()/2, Math.random()/2, 0.5, random(0, 360), Math.random()/15, 0.1);
				} else {
					Asteroids[i] = new SpaceObject(Sprite, 0, 0, x, y, speedx, speedy, 0.5, angle, speedangle, 0.2);
				}
				Asteroids[i].Sprite.anchor.set(0.5, 0.5);
  			Asteroids[i].Sprite.position.set(Asteroids[i].X, Asteroids[i].Y);
  			Asteroids[i].Sprite.scale.set(scale, scale);

  			app.stage.addChild(Asteroids[i].Sprite);
			}

			function GenerageAsteroidsWreckage(x, y, scale) {
				for (var q = 0; q < parseInt(random(2, 5)); q++) {
  				Asteroids.push(null);
  				if(q%2) { new_speedx = random(-0.5, 0.5); new_speedy = random(-0.5, 0.5); 
  				} else { new_speedx = random(-0.5, 0.5); new_speedy = random(-0.5, 0.5); }
  				InitAsteroid(Asteroids.length-1, random(scale*0.5, scale*0.8), 1,
  											x+random(-20, 20), y+random(-20, 20), new_speedx, new_speedy, random(0, 360), Math.random()/15);
  			}
			} 

			function AddBOOM(x, y) {
				BOOM = new PIXI.AnimatedSprite(BOOMTexture);
  			BOOM.scale.set(0.25, 0.25);
				BOOM.loop = false;
				BOOM.animationSpeed = 0.15;
				BOOM.anchor.set(0.5, 0.5);
  			BOOM.position.set(x, y);
  			app.stage.addChild(BOOM);
  			BOOM.onLoop = function () { app.stage.removeChild(localBOOM); };
  			return BOOM;
			} 

			function Dead() {
				setTimeout(()=>{app.stage.addChild(GameOver);}, 1000);
  			setTimeout(()=>{location.reload();}, 5000);
  			AddBOOM(SpaceShip.X, SpaceShip.Y).play();
  			app.stage.removeChild(SpaceShip.Sprite);
  			Life = false;
			}

			function GetSpeedsForAngle(Angle, Engine) {
				if(Angle < 90) {
        	SpeedX = Math.sin(Angle *Math.PI/180) * Engine;
        	SpeedY = -1*Math.cos(Angle *Math.PI/180) * Engine;
        }
				else if(Angle < 180) {
        	SpeedX = Math.cos((Angle-90) *Math.PI/180) * Engine;
        	SpeedY = Math.sin((Angle-90) *Math.PI/180) * Engine;
        }
        else if(Angle < 270) {
        	SpeedX = -1*Math.sin((Angle-180) *Math.PI/180) * Engine;
        	SpeedY = Math.cos((Angle-180) *Math.PI/180) * Engine;
        }
        else {
        	SpeedX = -1*Math.cos((Angle-270) *Math.PI/180) * Engine;
        	SpeedY = -1*Math.sin((Angle-270) *Math.PI/180) * Engine;
        }
        return [SpeedX, SpeedY];
			}

			class SpaceObject {
			  constructor(Sprite, PowerForwardEngine, PowerTurnEngine, X, Y, SpeedX, SpeedY, MaxSpeed, Angle, ChangeAnrgleSpeed, MaxChangeAnrgleSpeed) { 
			    this.Sprite = Sprite;
			    this.PowerForwardEngine = PowerForwardEngine;
			    this.PowerTurnEngine = PowerTurnEngine;
			  	this.X = X; this.Y = Y;
			  	this.SpeedX = SpeedX; this.SpeedY = SpeedY;
			    this.MaxSpeed = MaxSpeed;
			  	this.Angle = Angle;
			  	this.ChangeAnrgleSpeed = ChangeAnrgleSpeed;
			    this.MaxChangeAnrgleSpeed = MaxChangeAnrgleSpeed;
			  }
			}

			let SpaceShip = new SpaceObject(null, 0.1, 0.5, 640, 360, 0, 0, 1.5, random(0, 360), random(0, 0.05), 3);
			let Asteroids = new Array(15);
			let Lasers = new Array();

			document.addEventListener('keydown', (event) => {
			  if(event.key === 'd' || event.key === 'ArrowRight') { 
			  	SpaceShip.ChangeAnrgleSpeed = SpaceShip.ChangeAnrgleSpeed + SpaceShip.PowerTurnEngine; 
			  	if(SpaceShip.ChangeAnrgleSpeed > SpaceShip.MaxChangeAnrgleSpeed) { SpaceShip.ChangeAnrgleSpeed = SpaceShip.MaxChangeAnrgleSpeed; }
			  }
			  if(event.key === 'a' || event.key === 'ArrowLeft') { 
			  	SpaceShip.ChangeAnrgleSpeed = SpaceShip.ChangeAnrgleSpeed - SpaceShip.PowerTurnEngine; 
			  	if(SpaceShip.ChangeAnrgleSpeed < -1*SpaceShip.MaxChangeAnrgleSpeed) { SpaceShip.ChangeAnrgleSpeed = -1*SpaceShip.MaxChangeAnrgleSpeed; }
			  }

			  if((event.key === ' ' || event.key === 'Spacebar') && GunReady) { 
			  	GunReady = false;
	  			setTimeout(()=>{GunReady = true;}, 1000);
			  	Angle = (SpaceShip.Angle+36000000)%360;
			  	let laser = new SpaceObject(null, 0, 0, SpaceShip.X, SpaceShip.Y, 0, 0, SpeedLaser, (SpaceShip.Angle+6000000)%6, 0, 0);
			  	laser.Sprite = new PIXI.Sprite(PIXI.loader.resources["sprites/laser.png"].texture);
          let Speeds = GetSpeedsForAngle(Angle, SpeedLaser);
			  	laser.SpeedX = Speeds[0];
			  	laser.SpeedY = Speeds[1];
			  	laser.Sprite.anchor.set(0.5, 0.5);
			  	console.log(Angle, SpaceShip.Angle);
  				laser.Sprite.scale.set(0.25, 0.25);
			  	app.stage.addChild(laser.Sprite);
			  	Lasers.push(laser);
			  }

			  if(event.key === 'w' || event.key === 'ArrowUp') { 
			  	Angle = (SpaceShip.Angle+36000000)%360;
          
          let Speeds = GetSpeedsForAngle(Angle, SpaceShip.PowerForwardEngine);
          console.log(Speeds);
          SpaceShip.SpeedX += Speeds[0];
          SpaceShip.SpeedY += Speeds[1];

          if(SpaceShip.SpeedX > SpaceShip.MaxSpeed) { SpaceShip.SpeedX = SpaceShip.MaxSpeed; }
        	if(SpaceShip.SpeedX < -1*SpaceShip.MaxSpeed) { SpaceShip.SpeedX = -1*SpaceShip.MaxSpeed; }
        	if(SpaceShip.SpeedY > SpaceShip.MaxSpeed) { SpaceShip.SpeedY = SpaceShip.MaxSpeed; }
        	if(SpaceShip.SpeedY < -1*SpaceShip.MaxSpeed) { SpaceShip.SpeedY = -1*SpaceShip.MaxSpeed; }
			  }
        
			}, false);

			let app = new PIXI.Application({ 
    		width: 1280, 
    		height: 720,                       
    		antialiasing: true, 
    		transparent: false, 
    		resolution: 1
  		});

			document.body.appendChild(app.view);
			let MainCanvas = new PIXI.Container();
			app.render(MainCanvas);

			app.view.style.position = "absolute";
			app.view.style.width = window.innerWidth + "px";
			app.view.style.height = window.innerHeight + "px";

			PIXI.loader
  					.add("sprites/spaceship.png")
  					.add("sprites/GameOver.png")
  					.add("sprites/laser.png")
  					.add("sprites/asteroid_1.png")
  					.add("sprites/asteroid_2.png")
  					.add("sprites/asteroid_3.png")
  					.add("sprites/asteroid_4.png")
  					.load(InitSpaceShip);

			function InitSpaceShip(progress,resources) {
  			SpaceShip.Sprite = new PIXI.Sprite(PIXI.loader.resources["sprites/spaceship.png"].texture);

  			SpaceShip.Sprite.anchor.set(0.5, 0.5);
  			SpaceShip.Sprite.position.set(512, 512);
  			SpaceShip.Sprite.scale.set(1.5, 1);
  			app.stage.addChild(SpaceShip.Sprite);

  			for (var i = 0; i < Asteroids.length; i++) { InitAsteroid(i, random(1, 3.5), 1, random(0, 1280), random(0, 720), Math.random()/2, Math.random()/2, random(0, 360), Math.random()/10); }

				let BOOMFrames = ["sprites/boom/0.gif", "sprites/boom/1.gif", "sprites/boom/2.gif", "sprites/boom/3.gif", "sprites/boom/4.gif", "sprites/boom/5.gif"];
				BOOMTexture = [];
				for (let i=0; i < 6; i++)	{ BOOMTexture.push(PIXI.Texture.from(BOOMFrames[i])); }

				GameOver = new PIXI.Sprite(PIXI.loader.resources["sprites/GameOver.png"].texture);
			  GameOver.anchor.set(0.5, 0.5);
  			GameOver.position.set(640, 360);
  			GameOver.scale.set(1, 1);

  			app.ticker.add(delta => WhileTrue(delta));
			}

			function WhileTrue() {
  			SpaceShip.X += SpaceShip.SpeedX;
  			SpaceShip.Y += SpaceShip.SpeedY;
  			SpaceShip.Angle += SpaceShip.ChangeAnrgleSpeed;

  			SpaceShip.Sprite.x = SpaceShip.X;
  			SpaceShip.Sprite.y = SpaceShip.Y;
  			SpaceShip.Sprite.angle = SpaceShip.Angle; 

  			if(SpaceShip.X > 1280 || SpaceShip.X < 0 ||
  				 SpaceShip.Y > 720 || SpaceShip.Y < 0) {
  				if(Life) { Dead(); Life = false; }
  			}

  			for (var i = 0; i < Lasers.length; i++) {
  				Lasers[i].X += Lasers[i].SpeedX;
  				Lasers[i].Y += Lasers[i].SpeedY;
  				Lasers[i].Sprite.x = Lasers[i].X;
  				Lasers[i].Sprite.y = Lasers[i].Y;
  				Lasers[i].Sprite.angle = Lasers[i].Angle; 
  			}

  			boom = false;

  			if(Asteroids.length < 35) {
  				Asteroids.push(null);
  				InitAsteroid(Asteroids.length-1, random(1, 3.5));
  			}

  			for (var i = 0; i < Asteroids.length; i++) {
  				if(Math.abs(Asteroids[i].X - SpaceShip.X) < 20 && Math.abs(Asteroids[i].Y - SpaceShip.Y) < 20) {
  					if(Life) {
  						Dead();
  						app.stage.removeChild(Asteroids[i].Sprite);
  						Life = false;
  					}
  				}
  				if(Asteroids[i].X > 1280+10 || Asteroids[i].X < -10 || Asteroids[i].Y > 720+10 || Asteroids[i].Y < -10) { 
							app.stage.removeChild(Asteroids[i].Sprite);
  						InitAsteroid(i, random(1, 3.5)); 
  				}

  				Asteroids[i].X += Asteroids[i].SpeedX;
  				Asteroids[i].Y += Asteroids[i].SpeedY;
  				Asteroids[i].Angle += Asteroids[i].ChangeAnrgleSpeed;
  				//Asteroids[i].Angle = Asteroids[i].Angle%36;

  				Asteroids[i].Sprite.x = Asteroids[i].X;
  				Asteroids[i].Sprite.y = Asteroids[i].Y;
  				Asteroids[i].Sprite.angle = Asteroids[i].Angle; 

  				for (var j = 0; j < Asteroids.length; j++) {
  					if(j != i) {
  						if(Math.abs(Asteroids[i].X - Asteroids[j].X) < 20 && Math.abs(Asteroids[i].Y - Asteroids[j].Y) < 20) {
  							if(Asteroids[i].Sprite.scale.x > 2 || Asteroids[j].Sprite.scale.x > 2) {
  								GenerageAsteroidsWreckage((Asteroids[i].X+Asteroids[j].X)/2, (Asteroids[i].Y+Asteroids[j].Y)/2, 
  																						Math.max(Asteroids[i].Sprite.scale.x, Asteroids[j].Sprite.scale.x)/2)
  							}
  							AddBOOM((Asteroids[i].X+Asteroids[j].X)/2, (Asteroids[i].Y+Asteroids[j].Y)/2).play();
  							
  							app.stage.removeChild(Asteroids[i].Sprite);
								app.stage.removeChild(Asteroids[j].Sprite);
  							Asteroids.splice(i, 1);
  							if(i>j) { Asteroids.splice(j, 1); } else { Asteroids.splice(j-1, 1); }
								boom = true; 
  							break;
  						}
  					}
					}
					if(boom) { break; }

					for (var j = 0; j < Lasers.length; j++) {
						if(Math.abs(Asteroids[i].X - Lasers[j].X) < 15 && Math.abs(Asteroids[i].Y - Lasers[j].Y) < 15) {
  						if(Asteroids[i].Sprite.scale.x > 2) {
  							GenerageAsteroidsWreckage(Asteroids[i].X, Asteroids[i].Y, Asteroids[i].Sprite.scale.x)
  						}
  						AddBOOM(Asteroids[i].X, Asteroids[i].Y).play();
  							
  						app.stage.removeChild(Asteroids[i].Sprite);
							app.stage.removeChild(Lasers[j].Sprite);
  						Asteroids.splice(i, 1);
  						Lasers.splice(j, 1);
							boom = true; 
  						break;
						}
					}
					if(boom) { break; }
				}

  			sleep(60/PhysicsFPS);
			}
		</script>
  
	</body>
</html>